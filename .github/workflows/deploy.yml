name: Build and Deploy to GoDaddy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Deploy only (skip build)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    if: ${{ !inputs.deploy_only }}
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      id: build
      run: |
        npm run build
        mkdir -p out/config
        cp config/recaptcha.php out/config/
        cp .htaccess out/
        cp contact-form-handler.php out/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: out/
        retention-days: 5

  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Download build artifacts
      if: ${{ !inputs.deploy_only }}
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: out
    
    - name: Checkout repository
      if: ${{ inputs.deploy_only }}
      uses: actions/checkout@v4

    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-apt-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install LFTP
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp

    - name: Deploy to GoDaddy
      run: |
        echo "Starting FTP deployment..."
        echo "Connecting to ${{ secrets.FTP_SERVER }}:${{ secrets.FTP_PORT }}"
        
        # Create LFTP commands
        cat > lftp_commands.txt << EOF
        set ssl:verify-certificate no
        set net:timeout 60
        set net:max-retries 3
        set net:reconnect-interval-base 5
        set net:reconnect-interval-multiplier 1
        set net:reconnect-interval-max 2
        open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} -p ${{ secrets.FTP_PORT }} ${{ secrets.FTP_SERVER }}
        mirror --verbose --reverse --delete --parallel=4 --exclude-glob .git* --exclude-glob node_modules --exclude-glob .DS_Store ./out/ public_html/earlthemonster.com/
        bye
        EOF
        
        # Execute LFTP commands
        lftp -f lftp_commands.txt
        
        echo "FTP deployment completed" 